<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatGPT</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <h1>ChatGPT</h1>
    <div id="chat-area">
      <p>
        <span class="assistant-message complete"
          >Asistent: Salut, cu ce te pot ajuta?</span
        >
      </p>
    </div>
    <form id="chat-form">
      <label for="user-input">Introdu întrebarea ta:</label><br />
      <input type="text" id="user-input" name="userInput" /><br />
      <button type="submit">Trimite</button>
    </form>

    <script>
      document
        .getElementById("chat-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const userInput = document.getElementById("user-input").value.trim();
          if (userInput === "") return;

          // Append user's message to chat area
          const userMessage = document.createElement("p");
          userMessage.classList.add("user-message");
          userMessage.textContent = `Tu: ${userInput}`;
          document.getElementById("chat-area").appendChild(userMessage);

          // Clear input field
          document.getElementById("user-input").value = "";

          // Fetch response from server
          try {
            const response = await fetch("/assistant", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({ userInput: userInput }),
            });

            if (!response.ok) {
              throw new Error(
                `Server responded with status ${response.status}`
              );
            }

            const reader = response.body.getReader();
            let lastParagraph = document.createElement("span");
            lastParagraph.className = "assistant-message";
            document.getElementById("chat-area").appendChild(lastParagraph);
            let isFirstChunk = true;
            let firstDeltaReceived = false;
            let initialText = "";

            function handleStream(data) {
              if (data.type === "textCreated" && isFirstChunk) {
                initialText = data.text.value;
                lastParagraph.textContent = `Asistent: ${initialText.replace(
                  /\【.*?\】/g,
                  ""
                )}`;
                isFirstChunk = false; // Now handle subsequent deltas normally
              } else if (data.type === "textDelta") {
                if (!firstDeltaReceived && data.textDelta === initialText) {
                  // If the first delta is identical to the initial text, ignore it
                  firstDeltaReceived = true; // Mark the first delta as received
                } else {
                  lastParagraph.textContent += data.textDelta.replace(
                    /\【.*?\】/g,
                    ""
                  );
                }
              }
            }

            reader.read().then(function processText({ done, value }) {
              if (done) {
                lastParagraph.classList.add("complete");
                return;
              }
              const chunk = new TextDecoder().decode(value, { stream: true });
              // It is possible that more than one JSON object is in a single chunk, hence the loop
              const jsonChunks = chunk.match(/\{.*?\}(?=\{)|\{.*?\}$/g);
              if (jsonChunks) {
                jsonChunks.forEach((json) => {
                  try {
                    const data = JSON.parse(json);
                    handleStream(data);
                  } catch (e) {
                    console.error("Error parsing JSON:", e);
                  }
                });
              }
              return reader.read().then(processText);
            });
          } catch (error) {
            console.error("A apărut o eroare:", error);
            const errorParagraph = document.createElement("p");
            errorParagraph.textContent = `A apărut o eroare: ${error.message}`;
            document.getElementById("chat-area").appendChild(errorParagraph);
          }
        });
    </script>
  </body>
</html>
